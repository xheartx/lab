<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>瀑布流</title>
		<script src="jquery-1.11.3.js" type="text/javascript" charset="utf-8"></script>
		<script src="ajax.js" type="text/javascript" charset="utf-8"></script>
		<style type="text/css">
			body {margin: 0;}
			.ul1 {width: 1080px; margin: 100px auto 0;}
			.ul1 li {list-style:none; width: 247px; list-style: none; float: left;
				margin-right: 10px;}
			.ul1 li div {border: 1px solid #666;padding: 10px;margin-bottom: 10px;}
			.ul1 li div img {width: 225px; display: block;}
			.ul1 li p {
				word-wrap: break-word;
				word-break: normal;
			}

		</style>
	</head>
	<body>
		<ul class="ul1">
			<li></li>
			<li></li>
			<li></li>
		</ul>
		<script type="text/javascript">
			window.onload = function(){
				var oUl = $(".ul1");
				var aLi = $(".ul1 li");
				var iLen = aLi.length;
				var iPage = 1;
				var b = true;


//				初始化数据处理
				getList();
				function getList(){
					ajax('get','getPics.php','cpage='+ iPage,function(data){
						//解析
						var data = JSON.parse(data);
						if (!data.length) {
							return;
						}

						for (var i=0; i<data.length; i++) {

							//获取高度最短的li
							var _index = getShort();
							var oDiv = document.createElement('div');
							var oImg = document.createElement('img');
							oImg.src = data[i].preview;
							oDiv.appendChild(oImg);
							var oP = document.createElement('p');
							oP.innerHTML = data[i].title;
							oDiv.appendChild(oP);
							aLi[_index].appendChild(oDiv);
							}
						}
						b = ture;
					);
				}

				function getShort(){
					var index = 0;
					var ih = aLi[index].offsetHeight;
					for (var i=1; i<iLen; i++){
						if (aLi[i].offsetHeight < ih) {
							index = i;
							ih = aLi[i].offsetHeight;
						}
					}
					return index;
				}
				window.onscroll = function(){

					var _index = getShort();
					var oLi = aLi[_index];
					var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
					if (getTop(oLi) + oLi.offsetHeight < document.documentElement.clientHeight + scrollTop ){
						if (b) {
							b = false;
							iPage++;
							getList();
						}

					}

				}
				function getTop(obj){
					var iTop = 0;
					while(obj){
						iTop += obj.offsetTop;
						obj = obj.offsetParent;
					}
					return iTop;
				}
			}
		</script>
	</body>
</html>
